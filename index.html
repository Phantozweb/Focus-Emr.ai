<html><head><base href=".">
<style>
/* Update color scheme and variables */
:root {
  --primary: #2196F3;
  --primary-dark: #1976D2;
  --secondary: #03A9F4;
  --background: #FAFAFA;
  --surface: #FFFFFF;
  --text-primary: #212121;
  --text-secondary: #757575;
  --accent: #FF4081;
  --error: #F44336;
  --success: #4CAF50;
  --warning: #FFC107;
  --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
  --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
  --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 16px;
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
  --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Enhanced base styles */
body {
  background: var(--background);
  color: var(--text-primary);
  line-height: 1.6;
  font-size: 16px;
  margin: 0;
  padding-top: 120px;
  overflow-x: hidden;
}

/* Modernized navbar */
.navbar {
  background: var(--surface);
  border-bottom: 1px solid rgba(0,0,0,0.1);
  padding: var(--spacing-md) var(--spacing-lg);
  display: flex;
  justify-content: space-between;
  align-items: center;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  z-index: 1000;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.navbar h1 {
  font-size: 1.5rem;
  color: var(--primary);
  margin: 0;
  font-weight: 600;
}

/* Export button styles */
.export-btn {
  background: var(--surface);
  color: var(--primary);
  border: 1px solid var(--primary);
  padding: var(--spacing-sm) var(--spacing-md);
  border-radius: var(--radius-sm);
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.export-btn:hover {
  background: var(--primary);
  color: white;
  transform: translateY(-1px);
}

.export-btn svg {
  width: 16px;
  height: 16px;
}

/* Enhanced tab container */
.tab-container {
  position: fixed;
  top: 60px;
  left: 0;
  right: 0;
  background: var(--surface);
  z-index: 999;
  padding: 16px;
  box-shadow: var(--shadow-sm);
  transition: background-color 0.3s ease;
  display: flex;
  justify-content: center;
  align-items: center;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(0,0,0,0.1);
}

.tab-container .tab-group {
  background: rgba(0,0,0,0.05);
  padding: 4px;
  border-radius: 16px;
  display: flex;
  gap: 4px;
  max-width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}

.tab-container .tab-group::-webkit-scrollbar {
  display: none;
}

.tab {
  padding: 8px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  color: var(--text-secondary);
  background: transparent;
  border: none;
  cursor: pointer;
  transition: all 0.3s ease;
}

.tab.active {
  background: var(--surface);
  color: var(--primary);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.tab:hover:not(.active) {
  background: rgba(0,0,0,0.03);
}

/* Update tab content styles */
.tab-content {
  display: block !important; /* Always show content */
  padding: 24px;
  margin-bottom: 24px;
  animation: fadeIn 0.3s ease-in-out;
  background: var(--surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
}

.tab-content h2 {
  color: var(--primary);
  margin-bottom: var(--spacing-lg);
  padding-bottom: var(--spacing-md);
  border-bottom: 1px solid rgba(0,0,0,0.1);
}

/* Enhanced form styles */
.form-group {
  position: relative;
  padding-top: 40px; /* Make room for suggestions above */
  margin-bottom: var(--spacing-lg);
  background: rgba(255, 255, 255, 0.7);
  padding: var(--spacing-lg);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(0,0,0,0.05);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  min-height: 120px; /* Increase minimum height */
}

.form-group:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateY(-2px);
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
}

.form-group label {
  display: block;
  margin-bottom: var(--spacing-sm);
  color: var(--text-primary);
  font-weight: 500;
  font-size: 0.9rem;
  transition: all 0.2s ease;
}

.form-group:focus-within label {
  color: var(--primary);
  transform: translateY(-2px);
}

input[type="text"],
input[type="number"],
input[type="date"],
input[type="email"],
input[type="tel"],
textarea {
  width: 100%;
  padding: var(--spacing-md);
  border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.1);
  background: var(--surface);
  font-size: 16px;
  transition: all 0.3s ease;
}

input:focus,
textarea:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(33, 150, 243, 0.1);
}

/* Add new animations */
@keyframes scaleIn {
  from {
    transform: scale(0.95);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

@keyframes dropdownIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Enhanced button styles */
button {
  background: var(--primary);
  color: white;
  padding: var(--spacing-sm) var(--spacing-lg);
  border: none;
  border-radius: var(--radius-sm);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-sm);
}

button:hover {
  background: var(--primary-dark);
  transform: translateY(-1px);
  box-shadow: var(--shadow-md);
}

button:active {
  transform: translateY(0);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  body {
    padding-top: 50px;
  }
  
  .navbar {
    padding: var(--spacing-sm) var(--spacing-md);
  }
  
  .navbar h1 {
    font-size: 1.25rem;
  }
  
  .tab-container {
    top: 50px;
    padding: 12px;
  }
  
  .tab {
    padding: 6px 12px;
    font-size: 13px;
  }
  
  .tab-content {
    margin-top: 100px;
    padding: 16px;
  }
  
  .form-group {
    margin-bottom: var(--spacing-md);
  }
  
  .container {
    padding: var(--spacing-md);
  }
}

/* Animation classes */
.fade-enter {
  opacity: 0;
  transform: translateY(20px);
}

.fade-enter-active {
  opacity: 1;
  transform: translateY(0);
  transition: var(--transition);
}

.fade-exit {
  opacity: 1;
  transform: translateY(0);
}

.fade-exit-active {
  opacity: 0;
  transform: translateY(20px);
  transition: var(--transition);
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInOut {
  0% {
    opacity: 0;
    transform: translateY(-20px);
  }
  10% {
    opacity: 1;
    transform: translateY(0);
  }
  90% {
    opacity: 1;
    transform: translateY(0);
  }
  100% {
    opacity: 0;
    transform: translateY(-20px);
  }
}

/* Analysis grid styles */
.analysis-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: var(--spacing-lg);
}

/* Remove cases panel styles */
.cases-panel {
  display: none;
}

/* Custom select2 styling */
.select2-container {
  width: 100% !important;
}

.select2-container .select2-selection--multiple {
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: var(--radius-sm);
  min-height: 38px;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice {
  background-color: var(--primary);
  color: white;
  border: none;
  border-radius: var(--radius-sm);
  padding: 2px 8px;
  margin: 2px;
}

.select2-container--default .select2-selection--multiple .select2-selection__choice__remove {
  color: white;
  margin-right: 5px;
}

.select2-dropdown {
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
}

.select2-search__field {
  padding: 6px !important;
}

.select2-results__option {
  padding: 8px 12px;
}

.select2-container--default .select2-results__option--highlighted[aria-selected] {
  background-color: var(--primary);
}

/* Additional styles for visual acuity interpretation */
.va-interpretation {
  margin-top: var(--spacing-md);
  padding: var(--spacing-md);
  background: rgba(33, 150, 243, 0.1);
  border-radius: var(--radius-lg);
  border: 1px solid var(--primary);
  transition: var(--transition);
  display: flex;
  flex-direction: column;
}

.va-interpretation table {
  width: 100%;
  border-collapse: collapse;
  margin-top: var(--spacing-sm);
}

.va-interpretation th,
.va-interpretation td {
  padding: var(--spacing-sm);
  text-align: left;
  border: 1px solid rgba(33, 150, 243, 0.2);
}

.va-interpretation th {
  background: rgba(33, 150, 243, 0.1);
  font-weight: 500;
}

.va-interpretation tr:nth-child(even) {
  background: rgba(255, 255, 255, 0.5);
}

/* Add these styles to enhance the dropdown appearance */
select.ios-select {
  display: none;
}

/* Style the suggestions container */
.suggestions-container {
  position: absolute;
  top: -40px;
  left: 0;
  right: 0;
  background: white;
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-md);
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 4px;
  padding: 8px;
  max-height: 200px;
  overflow-y: auto;
}

.suggestion-item {
  font-size: 0.9em; 
  line-height: 1.4;
  padding: 8px 12px;
  white-space: normal; 
  max-width: 100%;
  cursor: pointer;
  transition: background-color 0.2s ease;
  border: 1px solid var(--primary);
  border-radius: var(--radius-sm);
  flex: 1;
  text-align: center;
}

/* Add styles for number input arrows */
input[type="number"] {
  -moz-appearance: textfield;
}

input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.va-toggle {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 15px;
}

.switch {
  position: relative;
  display: inline-block;
  width: 60px;
  height: 34px;
}

.switch input {
  opacity: 0;
  width: 0;
  height: 0;
}

.slider {
  position: absolute;
  cursor: pointer;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: #ccc;
  transition: .4s;
}

.slider:before {
  position: absolute;
  content: "";
  height: 26px;
  width: 26px;
  left: 4px;
  bottom: 4px;
  background-color: white;
  transition: .4s;
}

input:checked + .slider {
  background-color: var(--primary);
}

input:checked + .slider:before {
  transform: translateX(26px);
}

.slider.round {
  border-radius: 34px;
}

.slider.round:before {
  border-radius: 50%;
}

.va-select {
  width: 100%;
  padding: 8px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.1);
  background: var(--surface);
}

.prescription-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: var(--spacing-lg);
  margin-top: var(--spacing-md);
}

.prescription-grid h4 {
  margin-bottom: var(--spacing-md);
  color: var(--primary);
  border-bottom: 1px solid rgba(0,0,0,0.1);
  padding-bottom: var(--spacing-sm);
}

.va-interpretation table td[rowspan] {
  background: rgba(33, 150, 243, 0.05);
  font-weight: 500;
}

.va-selector {
  display: flex;
  flex-direction: column;
  gap: var(--spacing-sm);
}

.va-selector small {
  color: var(--text-secondary);
  margin-top: -5px;
  margin-bottom: 5px;
}

#durationUnit, #durationValue {
  padding: 8px;
  border-radius: var(--radius-sm);
  border: 1px solid rgba(0,0,0,0.1);
  background: var(--surface);
}

#durationValue::-webkit-inner-spin-button,
#durationValue::-webkit-outer-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.duration-detail-container {
  display: none;
}
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>

<nav class="navbar">
  <h1>Focus EMR.AI</h1>
  <div style="display: flex; gap: 10px;">
    <button onclick="exportToMarkdown()" class="export-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M14 3v4a1 1 0 0 0 1 1h4"></path>
        <path d="M17 21H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h7l5 5v11a2 2 0 0 1-2 2z"></path>
        <line x1="9" y1="9" x2="15" y2="9"></line>
        <line x1="9" y1="13" x2="15" y2="13"></line>
        <line x1="9" y1="17" x2="13" y2="17"></line>
      </svg>
      Copy MD
    </button>
    <button onclick="exportToPDF()" class="export-btn">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
      Export PDF
    </button>
  </div>
</nav>

<div class="container">
  <div class="grid">
    <main class="main">
      <div class="tab-container">
        <div class="tab-group">
          <button class="tab active" data-tab="info">Patient Info</button>
          <button class="tab" data-tab="symptoms">Signs & Symptoms</button> 
          <button class="tab" data-tab="history">Medical History</button>
          <button class="tab" data-tab="exam">Examination</button>
          <button class="tab" data-tab="prescription">Prescription</button>
          <button class="tab" data-tab="revisit">Revisit</button>
        </div>
      </div>

      <div class="tab-content" id="info">
        <h2>Patient Information</h2>
        <form id="patientForm">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="fullName" name="fullName" required title="Enter patient's full name">
          </div>
          <div class="form-group">
            <label>MRD Number</label>
            <input type="text" id="mrdNumber" name="mrdNumber" required title="Enter medical record number">
            <small>Medical Record Number</small>
          </div>
          
          <div class="form-group">
            <label>Age</label>
            <input type="number" id="age" name="age" min="0" max="120" required title="Enter patient's age">
          </div>
          
          <div class="form-group">
            <label>Gender</label>
            <input type="text" id="gender" name="gender" title="Select patient's gender">
          </div>
        </form>
      </div>

      <div class="tab-content" id="symptoms">
        <h2>Signs & Symptoms</h2>
        
        <div class="form-group">
          <label>Purpose of Visit</label>
          <input type="text" id="purposeOfVisit" title="Enter reason for visit (e.g. Consultation, Review, Emergency)">
        </div>

        <div class="form-group">
          <label>Chief Complaint</label>
          <input type="text" id="chiefComplaint" title="Enter main complaint">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="durationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="durationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>
        
        <div class="form-group">
          <label>Additional Notes</label>
          <textarea id="symptomNotes" rows="3" title="Enter any additional notes about symptoms"></textarea>
        </div>
      </div>

      <div class="tab-content" id="history">
        <h2>Medical History</h2>

        <!-- 1. Ocular History -->
        <div class="form-group">
          <label>Past Ocular History</label>
          <input type="text" id="ocularHistory" title="Enter past eye conditions or treatments">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="ocularHistoryDurationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="ocularHistoryDurationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>

        <!-- 2. Medical History -->
        <div class="form-group">
          <label>Past Medical History</label>
          <input type="text" id="pastMedicalHistory" title="Enter past medical conditions">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="pastMedicalHistoryDurationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="pastMedicalHistoryDurationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>

        <!-- 3. Current Medications -->
        <div class="form-group">
          <label>Current Medications</label>
          <input type="text" id="currentMedications" title="Enter current medications">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="currentMedicationsDurationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="currentMedicationsDurationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>

        <!-- 4. Allergies -->
        <div class="form-group">
          <label>Allergies</label>
          <input type="text" id="allergies" title="Enter any allergies">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="allergiesDurationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="allergiesDurationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>

        <!-- 5. Family History -->
        <div class="form-group">
          <label>Family History</label>
          <input type="text" id="familyHistory" title="Enter relevant family medical history">
          <div style="display: flex; gap: 10px; margin-top: 10px;">
            <select id="familyHistoryDurationUnit" style="flex: 1;">
              <option value="">Select Duration Unit</option>
              <option value="days">Days</option>
              <option value="weeks">Weeks</option>
              <option value="months">Months</option>
              <option value="years">Years</option>
            </select>
            <input type="number" id="familyHistoryDurationValue" style="flex: 1;" min="1" placeholder="Enter duration value">
          </div>
        </div>

      </div>

      <div class="tab-content" id="exam">
        <h2>Eye Examination</h2>
        
        <div class="form-group">
          <label>Visual Acuity Assessment</label>
          <div class="va-toggle">
            <label class="switch">
              <input type="checkbox" id="vaFormatToggle">
              <span class="slider round"></span>
            </label>
            <span id="vaFormatLabel">Snellen</span>
          </div>
          <div class="prescription-grid">
            <!-- Distance Vision -->
            <div>
              <h4>Distance Vision</h4>
              <div>
                <label>Right Eye (OD)</label>
                <div class="va-selector">
                  <select id="vaRightUnaidedDistance" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Unaided</small>
                  <select id="vaRightAidedDistance" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Aided</small>
                </div>
              </div>
              <div>
                <label>Left Eye (OS)</label>
                <div class="va-selector">
                  <select id="vaLeftUnaidedDistance" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Unaided</small>
                  <select id="vaLeftAidedDistance" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Aided</small>
                </div>
              </div>
            </div>
            <!-- Near Vision -->
            <div>
              <h4>Near Vision</h4> 
              <div>
                <label>Right Eye (OD)</label>
                <div class="va-selector">
                  <select id="vaRightUnaidedNear" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Unaided</small>
                  <select id="vaRightAidedNear" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Aided</small>
                </div>
              </div>
              <div>
                <label>Left Eye (OS)</label>
                <div class="va-selector">
                  <select id="vaLeftUnaidedNear" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Unaided</small>
                  <select id="vaLeftAidedNear" class="va-select" onchange="updateVAInterpretation()">
                    <option value="">Select VA</option>
                  </select>
                  <small>Aided</small>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-group">
          <div class="va-interpretation" id="vaInterpretation">
            Select visual acuity measurements above to see interpretation.
          </div>
        </div>

        <div class="form-group">
          <label>Intraocular Pressure</label>
          <div class="prescription-grid">
            <div>
              <label>Left Eye (mmHg)</label>
              <input type="number" id="iopLeft" title="Enter IOP reading in mmHg">
            </div>
            <div>
              <label>Right Eye (OD)</label>
              <input type="number" id="iopRight" title="Enter IOP reading in mmHg">
            </div>
          </div>
        </div>

        <div class="form-group">
          <label>Procedures</label>
          <input type="text" id="procedures" title="Enter procedures performed">
          <div id="otherProcedureContainer" class="duration-detail-container">
            <label>Other procedure(s</label>
            <input type="text">
          </div>
        </div>

        <div class="form-group">
          <label>Examination Notes</label>
          <textarea id="examNotes" rows="3" title="Enter examination findings and notes"></textarea>
        </div>

        <div id="refractionResults" class="form-group">
          <label>Retinoscopy Results</label>
          <div class="prescription-grid">
            <div>
              <h3>Right Eye (OD)</h3>
              <div class="form-group">
                <label>SPH (Sphere)</label>
                <input type="number" id="retinoscopySphRight" step="0.25" title="Enter sphere value">
              </div>
              <div class="form-group">
                <label>CYL (Cylinder)</label>
                <input type="number" id="retinoscopyCylRight" step="0.25" title="Enter cylinder value">
              </div>
              <div class="form-group">
                <label>Axis</label>
                <input type="number" id="retinoscopyAxisRight" min="1" max="180" title="Enter axis value">
              </div>
            </div>
            <div>
              <h3>Left Eye (OS)</h3>
              <div class="form-group">
                <label>SPH (Sphere)</label>
                <input type="number" id="retinoscopySphLeft" step="0.25" title="Enter sphere value">
              </div>
              <div class="form-group">
                <label>CYL (Cylinder)</label>
                <input type="number" id="retinoscopyCylLeft" step="0.25" title="Enter cylinder value">
              </div>
              <div class="form-group">
                <label>Axis</label>
                <input type="number" id="retinoscopyAxisLeft" min="1" max="180" title="Enter axis value">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="prescription">
        <h2>Prescription and Recommendations</h2>
        
        <div class="prescription-grid">
          <div>
            <h3>Right Eye (OD)</h3>
            <div class="form-group">
              <label>SPH (Sphere)</label>
              <input type="number" id="sphRight" step="0.25" title="Enter sphere value">
            </div>
            <div class="form-group">
              <label>CYL (Cylinder)</label>
              <input type="number" id="cylRight" step="0.25" title="Enter cylinder value">
            </div>
            <div class="form-group">
              <label>Axis</label>
              <input type="number" id="axisRight" min="1" max="180" title="Enter axis value">
            </div>
            <div class="form-group">
              <label>Add</label>
              <input type="number" id="addRight" step="0.25" title="Enter add value">
            </div>
          </div>
          <div>
            <h3>Left Eye (OS)</h3>
            <div class="form-group">
              <label>SPH (Sphere)</label>
              <input type="number" id="sphLeft" step="0.25" title="Enter sphere value">
            </div>
            <div class="form-group">
              <label>CYL (Cylinder)</label>
              <input type="number" id="cylLeft" step="0.25" title="Enter cylinder value">
            </div>
            <div class="form-group">
              <label>Axis</label>
              <input type="number" id="axisLeft" min="1" max="180" title="Enter axis value">
            </div>
            <div class="form-group">
              <label>Add</label>
              <input type="number" id="addLeft" step="0.25" title="Enter add value">
            </div>
          </div>
        </div>
      </div>

      <div class="tab-content" id="revisit">
        <h2>Revisit and Follow-Up</h2>
        
        <div class="form-group">
          <label>Revisit Visual Acuity - Right Eye</label>
          <input type="text" id="revisitVaRight">
        </div>
        
        <div class="form-group">
          <label>Revisit Visual Acuity - Left Eye</label>
          <input type="text" id="revisitVaLeft">
        </div>
        
        <div class="form-group">
          <label>Follow-Up Schedule</label>
          <input type="date" id="followUpSchedule" title="Select next appointment date">
        </div>
        
        <div class="form-group">
          <label>Medications</label>
          <input type="text" id="medications" title="Enter prescribed medications">
          <div id="otherMedicationContainer" class="duration-detail-container">
            <input type="text">
          </div>
        </div>
        
        <div class="form-group">
          <label>Additional Investigations</label>
          <input type="text" id="additionalInvestigations" title="Enter additional tests needed">
          <div id="otherInvestigationContainer" class="duration-detail-container">
            <input type="text">
          </div>
        </div>
        
        <div class="form-group">
          <label>Patient Education</label>
          <input type="text" id="patientEducation" title="Enter education/instructions given">
          <div id="otherEducationContainer" class="duration-detail-container">
            <input type="text">
          </div>
        </div>
        
        <div class="form-group">
          <label>Specialist Referral</label>
          <input type="text" id="specialistReferral" title="Enter referral details if needed">
          <div id="otherReferralContainer" class="duration-detail-container">
            <input type="text">
          </div>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
const VA_VALUES_SNELLEN = [
  '6/6', '6/9', '6/12', '6/18', '6/24', '6/36', '6/60', 
  '3/60', '1/60', 'CF', 'HM', 'LP', 'NLP'
];

const VA_VALUES_LOGMAR = [
  '0.0', '0.18', '0.3', '0.48', '0.6', '0.78', '1.0',
  '1.3', '1.78', 'CF', 'HM', 'LP', 'NLP'
];

const VA_MAPPINGS = {
  '6/6': {logmar: '0.0', description: 'Normal visual acuity'},
  '6/9': {logmar: '0.18', description: 'Slightly reduced vision'},
  '6/12': {logmar: '0.3', description: 'Mild visual impairment'},
  '6/18': {logmar: '0.48', description: 'Moderate visual impairment'},
  '6/24': {logmar: '0.6', description: 'Significant visual impairment'},
  '6/36': {logmar: '0.78', description: 'Severe visual impairment'},
  '6/60': {logmar: '1.0', description: 'Legal blindness threshold'},
  '3/60': {logmar: '1.3', description: 'Profound visual impairment'},
  '1/60': {logmar: '1.78', description: 'Near-total blindness'},
  'CF': {logmar: 'N/A', description: 'Counting Fingers'},
  'HM': {logmar: 'N/A', description: 'Hand Motion'},
  'LP': {logmar: 'N/A', description: 'Light Perception'},
  'NLP': {logmar: 'N/A', description: 'No Light Perception'}
};

const VA_VALUES_SNELLEN_NEAR = [
  'N5', 'N6', 'N8', 'N10', 'N12', 'N16', 'N20', 
  'N36', 'N60', 'CF Near', 'HM Near', 'LP Near', 'NLP Near'
];

const VA_VALUES_LOGMAR_NEAR = [
  '0.0', '0.18', '0.3', '0.48', '0.6', '0.78', '1.0',
  '1.3', '1.78', 'CF Near', 'HM Near', 'LP Near', 'NLP Near'  
];

const VA_MAPPINGS_NEAR = {
  'N5': {logmar: '0.0', description: 'Normal near vision'},
  'N6': {logmar: '0.18', description: 'Slightly reduced near vision'},
  'N8': {logmar: '0.3', description: 'Mild near vision impairment'},
  'N10': {logmar: '0.48', description: 'Moderate near vision impairment'}, 
  'N12': {logmar: '0.6', description: 'Significant near vision impairment'},
  'N16': {logmar: '0.78', description: 'Severe near vision impairment'},
  'N20': {logmar: '1.0', description: 'Legal blindness threshold for near vision'},
  'N36': {logmar: '1.3', description: 'Profound near vision impairment'},
  'N60': {logmar: '1.78', description: 'Near-total near vision blindness'},
  'CF Near': {logmar: 'N/A', description: 'Counting Fingers Near'},
  'HM Near': {logmar: 'N/A', description: 'Hand Motion Near'},
  'LP Near': {logmar: 'N/A', description: 'Light Perception Near'},
  'NLP Near': {logmar: 'N/A', description: 'No Light Perception Near'}
};

const PRESCRIPTION_STEPS = {
  sph: 0.25,
  cyl: 0.25,
  axis: 1,
  add: 0.25
};

let recentSelections = {
  'purposeOfVisit': ['Consultation', 'Review', 'Emergency'],
  'chiefComplaint': ['Blurred Vision', 'Eye Pain', 'Vision Loss'],
  'ocularHistory': ['No History of Ocular Issues', 'Refractive Errors', 'Cataract Surgery'],
  'pastMedicalHistory': ['No Known Medical Conditions', 'Diabetes Mellitus', 'Hypertension'],
  'allergies': ['No Known Allergies', 'Drug Allergies', 'Seasonal Allergies'],
  'familyHistory': ['No Significant Family History', 'Glaucoma', 'Diabetes'],
  'medications': ['No Current Medications', 'Eye Drops', 'Blood Pressure Medication'],
  'additionalInvestigations': ['OCT Scan', 'Visual Field Test', 'Fundus Photography'],
  'patientEducation': ['Digital Eye Strain', 'Contact Lens Care', 'Eye Hygiene'],
  'specialistReferral': ['Retina Specialist', 'Glaucoma Specialist', 'Cornea Specialist'],
  'gender': ['Male', 'Female', 'Other']
};

const fullSuggestions = {
  'purposeOfVisit': [
    'Consultation', 
    'Consultation - Routine Eye Examination',
    'Consultation - Vision Testing and Prescription Update',
    'Consultation - Eye Health Screening',
    'Consultation - Refractive Error Correction',
    'Consultation - Diagnosis of Eye Diseases',
    'Consultation - Eye Injury Management',
    'Consultation - Treatment for Eye Infections',
    'Consultation - Dry Eye Evaluation and Treatment',
    'Consultation - Binocular Vision Assessment',
    'Consultation - Pediatric Eye Exam and Vision Screening',
    'Consultation - Presbyopia Management',
    'Consultation - Visual Rehabilitation',
    'Consultation - Glaucoma Screening and Management',
    'Consultation - Macular Degeneration Screening and Management',
    'Consultation - Retinal Disease Screening',
    'Consultation - Eye Pain Evaluation',
    'Consultation - Evaluation of Visual Disturbances',
    'Consultation - Ocular Surface Disease Management',
    'Consultation - Eye Care Consultation for Contact Lens Wearers',
    'Consultation - School Vision Screening',
    'Consultation - Vision Screening for Special Needs or Disabilities',
    'Consultation - Second Opinion for Eye Surgery or Treatment',
    'Consultation - Vision Assessment for Sports',
    'Consultation - Vision Assessment for Driving',
    'Consultation - Pre-employment Eye Exam',
    'Consultation - Eye Care Advice for High-Risk Groups',
    'Consultation - Workplace Eye Safety Consultation',
    'Consultation - Consultation for Ocular Surface Disease',
    'Consultation - Ocular Prosthesis Fitting and Evaluation',
    'Consultation - Nutritional Counseling for Eye Health',
    'Consultation - Management of Ocular Allergies',
    'Consultation - Contact Lens Fitting',
    'Consultation - Eye Muscle Imbalance Evaluation',
    'Consultation - Visual Field Testing',
    'Consultation - Pediatric Vision Issues',
    'Consultation - Low Vision Services and Rehabilitation',
    'Consultation - Evaluation for Night Vision Issues',
    'Consultation - Post-Operative Cataract Evaluation',
    'Consultation - Diabetic Eye Disease Consultation',
    'Consultation - Retina Health Monitoring for Age-related Changes',
    'Consultation - Management of Refractive Surgery',
    'Consultation - Ocular Surface Disease Consultation',
    'Consultation - Screening for Eye Cancer',
    'Consultation - Hypermetropia Evaluation',
    'Consultation - Myopia Management',
    'Consultation - Strabismus and Binocular Vision Dysfunction Consultation',
    'Consultation - Presbyopia Evaluation',
    'Consultation - Contact Lens Review and Consultation',
    'Consultation - Dry Eye Management Consultation',
    'Consultation - Headache Evaluation Related to Vision Problems',
    'Review',
    'Review - Follow-up Consultation for Chronic Eye Diseases',
    'Review - Review of Post-operative Recovery',
    'Review - Monitoring of Diabetic Eye Health',
    'Review - Review After Vision Therapy or Rehabilitation',
    'Review - Follow-up for Vision Prescription Changes',
    'Review - Long-term Vision Care Consultation',
    'Review - Consultation for Sudden Vision Changes or Symptoms',
    'Review - Periodic Vision Review for Patients on Long-term Medication',
    'Review - Ongoing Consultation for Eye Injury Recovery',
    'Review - Review of Contact Lens Wear and Fit',
    'Review - Consultation for Eye Problems Related to Neurological Conditions',
    'Review - Follow-up for Glaucoma Treatment',
    'Review - Cataract Surgery Follow-up',
    'Review - Retina Surgery Follow-up',
    'Review - Follow-up After Visual Field Testing',
    'Review - Vision Therapy Progress Check',
    'Review - Pediatric Vision Follow-up',
    'Review - Review of Treatment Plan for Eye Allergies',
    'Review - Post-surgical Evaluation for Refractive Surgery',
    'Review - Contact Lens Follow-up for Complications or Fit',
    'Review - Low Vision Rehabilitation Review',
    'Review - Follow-up for Retinal Surgery',
    'Review - Post-operative Cataract Follow-up',
    'Follow-Up',
    'Follow-Up - Post-treatment Review for Ocular Disorders',
    'Follow-Up - Follow-up for Long-term Eye Conditions',
    'Follow-Up - Follow-up for Contact Lens Fitting',
    'Follow-Up - Follow-up After Vision Therapy or Exercises',
    'Follow-Up - Follow-up for Eye Conditions Post Surgery',
    'Follow-Up - Follow-up for Visual Acuity Changes',
    'Follow-Up - Post-surgical Follow-up for LASIK or Cataract Surgery',
    'Follow-Up - Follow-up for Eye Infection Management',
    'Follow-Up - Ongoing Review of Dry Eye Management',
    'Follow-Up - Monitoring Progress of Presbyopia Treatment',
    'Follow-Up - Recurrent Eye Disease Review',
    'Follow-Up - Follow-up for Vision Care After Neurological Conditions',
    'Follow-Up - Follow-up for Diabetic Retinopathy Screening',
    'Follow-Up - Glaucoma Management Follow-up',
    'Follow-Up - Retinal Detachment Post-repair Follow-up',
    'Prescription - New Spectacle Prescription',
    'Prescription - Prescription for Contact Lenses',
    'Prescription - Specialty Contact Lens Fitting',
    'Prescription - Prescription for Low Vision Aids',
    'Prescription - Prescription for Magnifiers and Other Visual Aids',
    'Prescription - Presbyopia Glasses/Reading Glasses Prescription',
    'Prescription - Sports Glasses Prescription',
    'Prescription - Prescription for Occupational Safety Glasses',
    'Prescription - Prescription for Sunglasses',
    'Prescription - Prescription for Anti-reflective Coating or Blue Light Filter',
    'Contact Lenses - Initial Fitting and Consultation',
    'Contact Lenses - Follow-up for Contact Lens Fitting',
    'Contact Lenses - Evaluation for Contact Lens Complications',
    'Contact Lenses - Specialized Fitting for Astigmatism or Keratoconus',
    'Contact Lenses - Contact Lens Prescription Update',
    'Contact Lenses - Scleral Contact Lens Fitting',
    'Contact Lenses - Contact Lens Care and Maintenance Consultation',
    'Contact Lenses - Soft, Rigid, or Hybrid Contact Lens Fitting',
    'Vision Therapy - Initial Consultation for Vision Therapy',
    'Vision Therapy - Follow-up for Vision Therapy Progress',
    'Vision Therapy - Binocular Vision Dysfunction Treatment',
    'Vision Therapy - Amblyopia Therapy',
    'Vision Therapy - Treatment for Strabismus',
    'Vision Therapy - Convergence Insufficiency Treatment',
    'Surgical Evaluation - LASIK Surgery Consultation',
    'Surgical Evaluation - Cataract Surgery Consultation',
    'Surgical Evaluation - Retina Surgery Consultation',
    'Surgical Evaluation - Corneal Transplant Consultation',
    'Surgical Evaluation - Glaucoma Surgery Consultation',
    'Surgical Evaluation - Refractive Surgery Evaluation',
    'Surgical Evaluation - Eye Muscle Surgery Consultation',
    'Surgical Evaluation - Preoperative Consultation for Eyelid Surgery',
    'Surgical Evaluation - Consultation for Ocular Prosthetics',
    'Emergency',
    'Emergency - Eye Injury',
    'Emergency - Foreign Body Removal',
    'Emergency - Sudden Loss of Vision',
    'Emergency - Eye Infections',
    'Emergency - Eye Pain or Redness',
    'Emergency - Retinal Detachment Signs',
    'Emergency - Sudden Blurred Vision',
    'Emergency - Chemical Exposure to Eye',
    'Emergency - Acute Glaucoma Symptoms',
    'Emergency - Foreign Object Removal',
    'Emergency - Eye Trauma and Bleeding',
    'Emergency - Post-surgical Complication Follow-up',
    'Routine Check-Up - Periodic Eye Examination',
    'Routine Check-Up - Vision Check-up for Children',
    'Routine Check-Up - Routine Eye Exam for Elderly',
    'Routine Check-Up - Pre-employment Eye Exam',
    'Routine Check-Up - Driver\'s License Vision Exam',
    'Routine Check-Up - Vision Check for Athletes',
    'Miscellaneous - Visual Ergonomics Consultation',
    'Miscellaneous - Ocular Nutrition Advice',
    'Miscellaneous - Workplace Eye Safety Advice',
    'Miscellaneous - Consultation for High-Risk Groups',
    'Miscellaneous - Recommendations for Visual Aids',
    'Miscellaneous - Vision Enhancement for Aging',
    'Miscellaneous - Screening for Visual Disabilities',
    'Miscellaneous - Eye Care Advice for Frequent Screen Users',
    'Miscellaneous - Eye Safety for Children\'s Activities',
    'Miscellaneous - Pre-operative Vision Testing'
  ],
  'chiefComplaint': [
    'Blurred Vision',
    'Double Vision (Diplopia)',
    'Eye Pain',
    'Eye Discomfort',
    'Dry Eyes',
    'Excessive Tearing (Epiphora)',
    'Red Eyes (Conjunctivitis, Irritation)',
    'Itchy Eyes (Allergy-related)',
    'Sensitivity to Light (Photophobia)',
    'Headaches',
    'Eye Strain/Fatigue (Digital Eye Strain)',
    'Difficulty Reading (Presbyopia)',
    'Difficulty Seeing at Night (Night Blindness)',
    'Loss of Vision (Central or Peripheral)',
    'Floaters (Spots in Vision)',
    'Halos Around Lights (Cataracts)',
    'Glare Sensitivity',
    'Vision Loss in One Eye',
    'Frequent Change in Prescription',
    'Blurred Vision in One Eye',
    'Eye Discharge (Mucous, Pus)',
    'Crusting of Eyelids (Blepharitis)',
    'Foreign Body Sensation',
    'Excessive Squinting (Strabismus)',
    'Puffy or Swollen Eyelids',
    'Burning Sensation in Eyes',
    'Twitching of Eyelids (Blepharospasm)',
    'Redness of Eyes (Conjunctival Injection)',
    'Watery Eyes (Tearing)',
    'Visual Disturbances After Trauma',
    'Flashes of Light',
    'Blurry Vision after Cataract Surgery',
    'Changes in Color Perception',
    'Difficulty Focusing',
    'Dryness in Eyes',
    'Inability to Focus on Close Objects (Presbyopia)',
    'Difficulty with Distance Vision',
    'Unclear Vision in One Eye (Amblyopia)',
    'Night Vision Problems (Nyctalopia)',
    'Seeing Wavy or Distorted Lines (Macular Degeneration)',
    'Reduced Peripheral Vision (Glaucoma)',
    'History of Eye Injury or Trauma',
    'Visual Disturbances After Medication (Side effects)',
    'Chronic Redness of Eyes (Allergy, Infection)',
    'Eye Fatigue After Prolonged Computer Use',
    'Visual Impairment from Diabetes (Diabetic Retinopathy)',
    'Visual Impairment from High Blood Pressure (Hypertensive Retinopathy)',
    'Blurred Vision Due to Pregnancy (Hormonal Changes)',
    'Vision Problems in Children (Strabismus, Amblyopia)',
    'Difficulties in Bright Light (Photophobia)',
    'Poor Vision with Contact Lenses',
    'Decreased Vision after Eye Surgery',
    'Difficulty Seeing at Distance After Surgery',
    'Light Sensitivity Following Surgery',
    'Staring at Objects, Finding it Hard to Focus',
    'Difficulty Understanding Small Print',
    'Feeling of Eyes Being Heavy or Droopy',
    'Eye Discomfort from Air Pollution',
    'Eye Pain Due to Uncorrected Refractive Error',
    'Visual Problems Due to Refractive Errors'
  ],
  'pastMedicalHistory': [
    // Cardiovascular Conditions 
    'Hypertension (High Blood Pressure)',
    'Hypotension (Low Blood Pressure)', 
    'Coronary Artery Disease (CAD)',
    'Myocardial Infarction (Heart Attack)',
    'Angina Pectoris',
    'Congestive Heart Failure (CHF)',
    'Arrhythmias',
    'Heart Valve Disease',
    'Aortic Aneurysm',
    'Peripheral Artery Disease (PAD)',
    'Congenital Heart Defects',
    'Endocarditis',
    'Cardiomyopathy',
    'Stroke',
    'Transient Ischemic Attack (TIA)',
    'Pulmonary Embolism',
    'Deep Vein Thrombosis (DVT)',

    // Respiratory Conditions
    'Asthma',
    'Chronic Obstructive Pulmonary Disease (COPD)', 
    'Emphysema',
    'Chronic Bronchitis',
    'Pneumonia',
    'Tuberculosis (TB)',
    'Lung Cancer',
    'Pulmonary Hypertension', 
    'Sleep Apnea',
    'Pleural Effusion',
    'Pulmonary Fibrosis',
    'Cystic Fibrosis',
    'Bronchiectasis',
    'Interstitial Lung Disease',

    // Gastrointestinal Conditions
    'Gastroesophageal Reflux Disease (GERD)',
    'Peptic Ulcer Disease (PUD)',
    'Celiac Disease',
    'Crohn\'s Disease',
    'Ulcerative Colitis',
    'Irritable Bowel Syndrome (IBS)',
    'Gastroenteritis',
    'Gallstones',
    'Hepatitis',
    'Liver Cirrhosis',
    'Liver Cancer',
    'Pancreatitis',
    'Gallbladder Disease',
    'Diverticulitis',
    'Chronic Constipation',
    'Hemorrhoids',
    'Gastritis',
    'Malabsorption Syndromes',

    // Endocrine Conditions 
    'Diabetes Mellitus Type 1',
    'Diabetes Mellitus Type 2',
    'Hypothyroidism',
    'Hyperthyroidism',
    'Graves\' Disease',
    'Hashimoto\'s Thyroiditis',
    'Cushing\'s Syndrome',
    'Addison\'s Disease',
    'Polycystic Ovary Syndrome (PCOS)',
    'Pheochromocytoma',
    'Pituitary Disorders',
    'Hyperparathyroidism',
    'Hypoparathyroidism',

    // Renal Conditions
    'Chronic Kidney Disease (CKD)',
    'Acute Kidney Injury (AKI)',
    'Kidney Stones',
    'Nephrotic Syndrome',
    'Nephritis',
    'Polycystic Kidney Disease',
    'End-Stage Renal Disease (ESRD)',
    'Renal Transplant',
    'Urinary Tract Infection (UTI)',
    'Hydronephrosis',
    'Prostate Disorders',

    // Neurological Conditions
    'Seizure Disorder (Epilepsy)',
    'Parkinson\'s Disease',
    'Multiple Sclerosis',
    'Alzheimer\'s Disease',
    'Dementia',
    'Migraine',
    'Tension Headache',
    'Cluster Headache',
    'Neuralgia',
    'Bell\'s Palsy',
    'Peripheral Neuropathy',
    'Guillain-Barré Syndrome',
    'Amyotrophic Lateral Sclerosis (ALS)',
    'Huntington\'s Disease',
    'Brain Tumors',

    // Musculoskeletal Conditions
    'Osteoarthritis',
    'Rheumatoid Arthritis',
    'Gout',
    'Lupus (SLE)',
    'Ankylosing Spondylitis',
    'Osteoporosis',
    'Fibromyalgia',
    'Scoliosis',
    'Muscle Dystrophy',
    'Tendonitis',
    'Bursitis',
    'Fractures',
    'Sprains and Strains',

    // Hematological Conditions
    'Anemia',
    'Sickle Cell Disease',
    'Thalassemia',
    'Leukemia',
    'Lymphoma',
    'Hemophilia',
    'Vitamin K Deficiency',
    'Polycythemia Vera',
    'Platelet Disorders',

    // Psychiatric Conditions
    'Depression',
    'Bipolar Disorder',
    'Schizophrenia',
    'Anxiety Disorders',
    'Post-Traumatic Stress Disorder (PTSD)',
    'Obsessive-Compulsive Disorder (OCD)',
    'ADHD',
    'Eating Disorders',
    'Personality Disorders',
    'Autism Spectrum Disorder (ASD)',
    'Substance Use Disorders',
    'Insomnia',
    'Psychotic Disorders',

    // Infectious Diseases
    'HIV/AIDS',
    'Hepatitis',
    'Tuberculosis',
    'Malaria',
    'Chronic or Recurrent Infections',
    'Influenza',
    'Herpes Simplex Virus (HSV)',
    'Human Papillomavirus (HPV)',

    // Dermatological Conditions
    'Psoriasis',
    'Eczema',
    'Acne',
    'Seborrheic Dermatitis',
    'Contact Dermatitis',
    'Skin Cancer',
    'Vitiligo',
    'Hives',
    'Ringworm',
    'Fungal Infections',
    'Rosacea',
    'Keloids',

    // Allergic Conditions
    'Seasonal Allergies',
    'Food Allergies',
    'Drug Allergies',
    'Anaphylaxis',
    'Allergic Rhinitis',
    'Allergic Conjunctivitis',
    'Angioedema',
    'Urticaria',

    // Genetic and Inherited Conditions
    'Cystic Fibrosis',
    'Down Syndrome',
    'Marfan Syndrome',
    'Neurofibromatosis',
    'Tay-Sachs Disease',
    'Turner Syndrome',

    // Miscellaneous Conditions
    'Obesity',
    'Chronic Fatigue Syndrome',
    'Chronic Pain Syndrome',
    'Chronic Inflammatory Response Syndrome',
    'Organ Transplant',
    'Chronic Sinusitis',
    'Endometriosis',
    'Fibroids',
    'Incontinence',

    // Immunological Conditions
    'Sjögren\'s Syndrome',
    'Polymyalgia Rheumatica',
    'Sarcoidosis'
  ],
  'currentMedications': [
    'Timolol – Used for glaucoma to reduce intraocular pressure',
    'Latanoprost – Prostaglandin analogue used for glaucoma',
    'Bimatoprost – Prostaglandin analogue used for glaucoma',
    'Tafluprost – Prostaglandin analogue used for glaucoma', 
    'Spironolactone - A diuretic with potential effects on ocular pressure',
    'Brimonidine – Alpha-2 agonist used for glaucoma',
    'Dorzolamide – Carbonic anhydrase inhibitor used for glaucoma',
    'Acetazolamide – Oral carbonic anhydrase inhibitor used for glaucoma',
    'Pilocarpine – Cholinergic agent used for glaucoma and pupil constriction',
    'Carbachol – Cholinergic agent used for glaucoma and pupil constriction',
    'Betaxolol – Beta-blocker used for glaucoma',
    'Cosopt (Dorzolamide/Timolol) – Combination for glaucoma',
    'Combigan (Brimonidine/Timolol) – Combination for glaucoma',
    'Xalacom (Latanoprost/Timolol) – Combination for glaucoma',
    'Simbrinza (Brinzolamide/Brimonidine) – Combination for glaucoma',
    'Artificial Tears – Used to lubricate dry eyes',
    'Cyclosporine A (Restasis) – Immunosuppressant for dry eye',
    'Lifitegrast (Xiidra) – LFA-1 antagonist for dry eye',
    'Hydroxypropyl Methylcellulose – Lubricant for dry eye',
    'Carboxymethylcellulose – Lubricant for dry eye',
    'Polyvinyl Alcohol – Lubricant for dry eye',
    'Punctal Plugs – Devices for dry eye treatment',
    'Fluorometholone – Corticosteroid for inflammation',
    'Prednisolone Acetate – Corticosteroid for inflammation',
    'Dexamethasone Sodium Phosphate – Corticosteroid for inflammation',
    'Sodium Hyaluronate – Lubricant for dry eye',
    'Tear Gel – Gel-based artificial tears',
    'Restasis Multidose – Cyclosporine A for chronic dry eye',
    'Moxifloxacin (Vigamox) – Antibiotic for bacterial conjunctivitis',
    'Ciprofloxacin (Ciloxan) – Antibiotic for bacterial infections',
    'Ofloxacin (Ocuflox) – Antibiotic for bacterial infections',
    'Gentamicin (Gentak) – Antibiotic for eye infections',
    'Tobramycin (Tobrex) – Antibiotic for eye infections',
    'Chloramphenicol – Broad-spectrum antibiotic',
    'Erythromycin (Ilotycin) – Macrolide antibiotic ointment',
    'Sulfacetamide Sodium – Antibiotic for conjunctivitis',
    'Neomycin/Polymyxin B (Neosporin) – Combination antibiotic',
    'Trimethoprim/Polymyxin B (Polytrim) – Combination antibiotic',
    'Azithromycin (AzaSite) – Macrolide antibiotic',
    'Levofloxacin (Iquix) – Antibiotic for bacterial keratitis',
    'Acyclovir (Zovirax) – Antiviral for herpes simplex',
    'Valacyclovir (Valtrex) – Antiviral for herpes simplex',
    'Ganciclovir (Zirgan) – Antiviral for keratitis',
    'Trifluridine (Viroptic) – Antiviral for keratitis',
    'Loteprednol Etabonate (Lotemax) – Corticosteroid',
    'Tacrolimus (Prograf) – Immunosuppressant for uveitis',
    'Methotrexate – Immunosuppressant for autoimmune conditions',
    'Adalimumab (Humira) – Biologic for uveitis',
    'Ketotifen (Zaditor) – Antihistamine for allergies',
    'Olopatadine (Patanol) – Antihistamine for allergies',
    'Azelastine (Optivar) – Antihistamine for allergies',
    'Epinastine (Elestat) – Antihistamine for allergies',
    'Levocabastine – Antihistamine for allergies',
    'Bepotastine (Bepreve) – Antihistamine for allergies',
    'Cromolyn Sodium – Mast cell stabilizer',
    'Nedocromil (Alocril) – Mast cell stabilizer',
    'Pemirolast (Alamast) – Mast cell stabilizer',
    'Lodoxamide (Alomide) – Mast cell stabilizer',
    'Tropicamide – For pupil dilation',
    'Cyclopentolate – For pupil dilation',
    'Atropine – For pupil dilation',
    'Phenylephrine – For pupil dilation',
    'Bromfenac (Xibrom) – NSAID for post-cataract inflammation',
    'Nepafenac (Ilevro) – NSAID for post-cataract inflammation',
    'Flurbiprofen – NSAID for post-cataract inflammation',
    'Hydrocodone/Acetaminophen – Post-surgical pain relief',
    'Oxycodone/Acetaminophen – Post-surgical pain relief',
    'Betamethasone – For severe ocular inflammation',
    'Chlorhexidine – Antiseptic for surgeries',
    'Mupirocin – Antibiotic ointment',
    'Fusidic Acid – Antibiotic for bacterial infections',
    'Tetracycline – For ocular rosacea',
    'Oxytetracycline – For eye infections',
    'Sodium Chloride – For corneal edema',
    'N-acetylcysteine – For ocular surface disease',
    'Mycophenolate Mofetil – For uveitis management',
    'Azathioprine – For autoimmune ocular diseases',
    'No Current Medications'
  ],
  'allergies': [
    'No Known Allergies',
    'Allergic Conjunctivitis',
    'Seasonal Allergic Rhinitis (Hay Fever)',
    'Perennial Allergic Rhinitis', 
    'Atopic Dermatitis (Eczema)',
    'Contact Dermatitis',
    'Drug Allergies',
    'Latex Allergy',
    'Food Allergies',
    'Dust Mite Allergy',
    'Mold Allergy',
    'Pollen Allergy',
    'Animal Dander Allergy',
    'Insect Sting Allergies',
    'Bee Sting Allergy',
    'Wasps Sting Allergy',
    'Shellfish Allergy',
    'Peanut Allergy',
    'Tree Nut Allergy',
    'Milk Allergy',
    'Egg Allergy',
    'Soy Allergy',
    'Wheat Allergy',
    'Fish Allergy',
    'Aspirin Sensitivity',
    'Sulfa Drug Allergy',
    'Penicillin Allergy',
    'Non-steroidal Anti-inflammatory Drug (NSAID) Allergy',
    'Antihistamine Allergy',
    'Allergic Blepharitis',
    'Allergic Rhinitis',
    'Conjunctival Allergies',
    'Periorbital Edema (due to allergies)',
    'Angioedema (allergic)',
    'Urticaria (hives)',
    'Chronic Idiopathic Urticaria',
    'Drug-induced Urticaria',
    'Food-induced Urticaria',
    'Acute Allergic Reactions (Anaphylaxis)',
    'Anaphylactic Shock',
    'Allergy to Preservatives (in eye drops)',
    'Fragrance Allergies',
    'Nickel Allergy',
    'Grass Pollen Allergy',
    'Tree Pollen Allergy',
    'Ragweed Allergy',
    'Cockroach Allergy',
    'Allergy to Pet Dander',
    'Contact Lens Sensitivity',
    'Ocular Allergy Syndrome',
    'Photodermatitis (sun allergy)',
    'Ocular Surface Disease (related to allergies)',
    'Vasomotor Rhinitis',
    'Ocular Pruritus (itching due to allergies)',
    'Ocular Hyperemia (red eyes from allergies)',
    'Atopic Keratoconjunctivitis',
    'Vernal Keratoconjunctivitis',
    'Episodic Allergic Conjunctivitis',
    'Allergic Stinging Eye Syndrome',
    'Chronic Allergic Rhinitis with Ocular Involvement',
    'Ocular Eosinophilic Infiltration',
    'Allergy to Eye Cosmetics',
    'Allergy to Chlorine',
    'Allergy to Dust',
    'Allergy to Chemical Fumes',
    'Airborne Allergens',
    'Ocular Eczema',
    'Ocular Contact Dermatitis',
    'Ocular Pruritus with Atopy',
    'Ocular Lichenoid Reactions',
    'Ocular Chemical Conjunctivitis',
    'Allergy to Eye Drops',
    'Ocular Histamine Reaction',
    'Ocular Inflammation Due to Environmental Allergies',
    'Allergic Contact Dermatitis from Topical Medications',
    'Type 1 Hypersensitivity Reactions in Eyes',
    'Angioedema in Ocular Tissues',
    'Allergic Ocular Surface Disease',
    'Ocular Keratitis from Allergies',
    'Reactions to Cosmetic Eye Products',
    'Excessive Tearing from Environmental Allergies',
    'Chronic Eye Redness from Allergies',
    'Allergic Ocular Pain'
  ],
  'familyHistory': [
    'No Significant Family History',
    'Glaucoma',
    'Cataracts',
    'Macular Degeneration',
    'Retinitis Pigmentosa', 
    'Diabetic Retinopathy',
    'Strabismus',
    'Amblyopia (Lazy Eye)',
    'Keratoconus',
    'Retinal Diseases',
    'Color Blindness',
    'Juvenile Glaucoma',
    'Optic Neuropathies',
    'Blepharitis',
    'Retinal Detachment',
    'Eye Tumors (e.g., Retinoblastoma)',
    'Refractive Errors (Myopia)',
    'Refractive Errors (Hyperopia)',
    'Astigmatism',
    'Night Blindness',
    'Bleeding Disorders (e.g., Hemophilia)',
    'Pterygium',
    'Dry Eye Disease',
    'Choroidal Neovascularization',
    'Hereditary Retinal Degenerations',
    'Albinism',
    'Epiretinal Membranes',
    'Corneal Dystrophies',
    'Retinopathy of Prematurity (ROP)',
    'Sickle Cell Disease',
    'Ocular Albinism',
    'Macular Hole',
    'Congenital Nystagmus',
    'Hereditary Angioedema',
    'Congenital Cataracts',
    'Fuchs\' Endothelial Dystrophy',
    'Ocular Surface Tumors',
    'Lattice Degeneration',
    'Sjögren\'s Syndrome',
    'Marfan Syndrome',
    'Optic Neuritis',
    'Uveitis',
    'Hyperopia',
    'Retinal Vein Occlusion',
    'Retinal Artery Occlusion',
    'Myasthenia Gravis',
    'Graves\' Disease',
    'Thyroid Eye Disease',
    'Autoimmune Uveitis',
    'Orbital Tumors',
    'Convergence Insufficiency',
    'Eye Stroke (Ischemic Optic Neuropathy)',
    'Aniridia',
    'Ocular Melanoma',
    'Coloboma',
    'Hereditary Hemorrhagic Telangiectasia',
    'Pseudoexfoliation Syndrome',
    'Toxoplasmosis (Ocular)',
    'Orbital Cellulitis',
    'Papilledema',
    'Ocular Surface Squamous Neoplasia',
    'Leber Congenital Amaurosis',
    'Retinal Arterial Macroaneurysm',
    'Stargardt Disease',
    'Usher Syndrome',
    'Alport Syndrome',
    'Reticular Macular Degeneration',
    'Familial Exudative Vitreoretinopathy',
    'Eales Disease',
    'Recurrent Corneal Erosion Syndrome',
    'Acquired Color Vision Deficiency',
    'Familial Dysautonomia',
    'Optic Disc Drusen',
    'Familial Pseudoexfoliation Syndrome',
    'Medullary Thyroid Cancer (associated with RET mutations)',
    'Idiopathic Intracranial Hypertension',
    'Anterior Ischemic Optic Neuropathy',
    'Autosomal Dominant Optic Atrophy',
    'Familial Macular Dystrophy',
    'Keratitis',
    'Gonioscopy Abnormalities',
    'X-linked Retinitis Pigmentosa',
    'Autosomal Dominant Retinitis Pigmentosa',
    'Vogt-Koyanagi-Harada Disease',
    'Ocular Toxocariasis',
    'Rhodopsin Mutations',
    'Fuchs\' Dystrophy',
    'Wet Age-Related Macular Degeneration',
    'Dry Age-Related Macular Degeneration',
    'Ocular Involvement in Systemic Lupus Erythematosus',
    'Cystinosis (Ocular Involvement)',
    'Ocular Histoplasmosis Syndrome',
    'Cataracts in Childhood',
    'Acute Retinal Necrosis',
    'Hereditary Retinal Angiomatous Proliferation',
    'Familial Ocular Albinism',
    'Autoimmune Retinopathy',
    'Anterior Segment Dysgenesis',
    'Optic Nerve Hypoplasia',
    'Diabetic Macular Edema',
    'Angioid Streaks',
    'Marfan Syndrome (Ocular Manifestations)',
    'Idiopathic Ocular Inflammation',
    'Ocular Involvement in Sarcoidosis',
    'Langerhans Cell Histiocytosis (Ocular Manifestation)',
    'Choroiditis',
    'Hypertensive Retinopathy',
    'Ocular Sarcoidosis',
    'Neurofibromatosis (Type 1 and 2)',
    'Fuchs\' Dystrophy in Family History',
    'Ocular Histoplasmosis',
    'Inherited Night Blindness',
    'Retinopathy in Childhood',
    'Myopic Retinopathy',
    'Hereditary Macular Disease',
    'Familial Conjunctival Disorders',
    'Ocular Surface Squamous Neoplasia in Family',
    'Cone Dystrophy in Families',
    'Family History of Eye Surgery Complications',
    'Familial Eye Trauma',
    'Chronic Optic Neuropathy',
    'Retinal Arterial Macroaneurysm',
    'Retinal Vascular Occlusion Family History',
    'Genetic Retinal Diseases',
    'Family History of Retinal Tear',
    'Diabetic Eye Disease in Family History',
    'High Myopia with Family History',
    'Hereditary Ocular Tumors',
    'Systemic Autoimmune Disease (Ocular Manifestations)',
    'Family History of Retinal Vascular Diseases'
  ],
  'medications': [
    'No Medications',
  ],
  'additionalInvestigations': [
    'No Investigations',
  ],
  'patientEducation': [
    'No Education Needed',
  ],
  'specialistReferral': [
    'No Referral Needed',
  ],
  'gender': [
    'Male',
    'Female', 
    'Other',
    'Prefer not to say'
  ],
  'ocularHistory': [
    // Anterior Segment Conditions
    'Anterior Blepharitis',
    'Posterior Blepharitis', 
    'Conjunctivitis (Allergic)',
    'Conjunctivitis (Viral)',
    'Conjunctivitis (Bacterial)',
    'Dry Eye Disease',
    'Corneal Abrasion',
    'Corneal Ulcer',
    'Pterygium',
    'Pinguecula',
    'Blepharospasm',
    'Lid Lag',
    'Ptosis (Congenital)',
    'Ptosis (Acquired)', 
    'Ectropion',
    'Entropion',
    'Chalazion',
    'Stye (Hordeolum)',
    'Lid Marginal Keratitis',
    'Foreign Body in Eye',
    'Corneal Dystrophies (Anterior)',

    // Posterior Segment Conditions
    'Macular Degeneration (Age-related)',
    'Macular Hole',
    'Macular Edema (Diabetic, Cystoid, etc.)',
    'Diabetic Retinopathy (Non-Proliferative)',
    'Diabetic Retinopathy (Proliferative)',
    'Central Retinal Artery Occlusion (CRAO)',
    'Central Retinal Vein Occlusion (CRVO)',
    'Branch Retinal Vein Occlusion (BRVO)',
    'Retinal Detachment (Rhegmatogenous)',
    'Retinal Detachment (Exudative)',
    'Retinal Detachment (Tractional)',
    'Retinal Tear',
    'Retinal Hole',
    'Retinitis Pigmentosa',
    'Choroidal Neovascularization (CNV)',
    'Choroidal Melanoma',
    'Macular Pucker (Epiretinal Membrane)',
    'Retinopathy of Prematurity (ROP)',
    'Retinal Arteritis',
    'Choroiditis',
    'Sympathetic Ophthalmia',
    'Optic Neuritis',
    'Non-Arteritic Anterior Ischemic Optic Neuropathy (NAION)',
    'Arteritic Anterior Ischemic Optic Neuropathy (AION)',
    'Papilledema',
    'Optic Disc Drusen',
    'Leber\'s Hereditary Optic Neuropathy',

    // Glaucoma-Related Conditions
    'Primary Open-Angle Glaucoma (POAG)',
    'Angle-Closure Glaucoma',
    'Secondary Glaucoma (Neovascular)',
    'Secondary Glaucoma (Steroid-induced)',
    'Congenital Glaucoma',
    'Traumatic Glaucoma',
    'Pigmentary Glaucoma',
    'Exfoliative Glaucoma',
    'Normal-Tension Glaucoma',

    // Add Surgical History here
    'H/O Cataract Surgery',
    'H/O Trabeculectomy',
    'H/O Tube Shunt Surgery',
    'H/O LASIK Surgery',
    'H/O PRK Surgery',
    'H/O Strabismus Surgery',
    'H/O Corneal Transplant (DALK)',
    'H/O Corneal Transplant (DSEK)',
    'H/O Vitrectomy',
    'H/O Retinal Detachment Surgery',
    'H/O Scleral Buckling',
    'H/O Ocular Prosthetic Surgery',
    'H/O Enucleation',
    'H/O Exenteration',
    
    // Continue with other existing conditions...
    'Ocular Manifestations of HIV',
    'Ocular Manifestations of Hypertension',
    'Ocular Manifestations of Diabetes Mellitus',
    'Ocular Manifestations of Rheumatoid Arthritis',
    'Ocular Manifestations of Sjogren\'s Syndrome'
  ],
};

const ASSOCIATED_COMPLAINTS = {};

// Helper function to highlight matching text
function highlight(text, query) {
  // Escape special regex characters and parentheses in the query
  const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
  const regex = new RegExp(`(${escapedQuery})`, 'gi');
  return text.replace(regex, '<strong>$1</strong>');
}

// Add new function to update recent selections
function updateRecentSelections(fieldName, value) {
  if (!recentSelections[fieldName]) {
    recentSelections[fieldName] = [];
  }
  
  // Remove value if it already exists
  const index = recentSelections[fieldName].indexOf(value);
  if (index > -1) {
    recentSelections[fieldName].splice(index, 1);
  }
  
  // Add to beginning of array
  recentSelections[fieldName].unshift(value);
  
  // Keep only last 3 selections for most fields, but up to 5 for chiefComplaint
  const maxItems = fieldName === 'chiefComplaint' ? 5 : 3;
  recentSelections[fieldName] = recentSelections[fieldName].slice(0, maxItems);
}

function initializeSearchableFields() {
  const fields = [
    '#gender',
    '#purposeOfVisit',  
    '#chiefComplaint',
    '#ocularHistory',  
    '#currentMedications', 
    '#pastMedicalHistory',
    '#allergies',
    '#familyHistory',
    '#medications',
    '#additionalInvestigations', 
    '#patientEducation',
    '#specialistReferral'
  ];

  fields.forEach(fieldId => {
    const field = document.querySelector(fieldId);
    if (!field) return;

    // Create suggestions container
    const suggestionsContainer = document.createElement('div');
    suggestionsContainer.className = 'suggestions-container';
    field.parentNode.insertBefore(suggestionsContainer, field);

    // Show suggestions on input
    field.addEventListener('input', function(e) {
      const fieldName = fieldId.substring(1);
      const value = e.target.value.toLowerCase().trim();
      
      // Get all matching suggestions
      const allSuggestions = fullSuggestions[fieldName] || [];
      const matchingSuggestions = allSuggestions.filter(suggestion => {
        // Do case-insensitive contains match
        return suggestion.toLowerCase().includes(value);
      }).slice(0, 5); // Show top 5 matches

      // Display suggestions
      if (fieldName === 'chiefComplaint' && matchingSuggestions.length > 0) {
        suggestionsContainer.innerHTML = matchingSuggestions.map(suggestion => {
          try {
            return `<div class="suggestion-item" data-value="${suggestion}">
              ${highlight(suggestion, value)}
            </div>`;
          } catch (error) {
            console.error('Error highlighting suggestion:', error);
            return `<div class="suggestion-item" data-value="${suggestion}">
              ${suggestion}
            </div>`;
          }
        }).join('');
      } else {
        // Original suggestion display for other fields
        suggestionsContainer.innerHTML = matchingSuggestions.map(suggestion => {
          try {
            return `<div class="suggestion-item" data-value="${suggestion}">
              ${highlight(suggestion, value)}
            </div>`;
          } catch (error) {
            console.error('Error highlighting suggestion:', error);
            return `<div class="suggestion-item" data-value="${suggestion}">
              ${suggestion}
            </div>`;
          }
        }).join('');
      }
      
      // Add click handlers
      suggestionsContainer.querySelectorAll('.suggestion-item').forEach(item => {
        item.addEventListener('click', function() {
          field.value = this.dataset.value;
          suggestionsContainer.innerHTML = '';
          updateRecentSelections(fieldName, this.dataset.value);
        });
      });
    });

    // Clear suggestions when clicking outside
    document.addEventListener('click', function(e) {
      if (!e.target.closest(fieldId) && !e.target.closest('.suggestions-container')) {
        suggestionsContainer.innerHTML = '';
      }
    });
  });
}

// Update switchTab function to properly handle display
function switchTab(tabId) {
  // Remove active class from all tabs
  document.querySelectorAll('.tab').forEach(tab => {
    tab.classList.remove('active');
  });

  // Add active class to selected tab button
  const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"]`);
  if (selectedTab) {
    selectedTab.classList.add('active');
  }

  // Scroll to section with smooth behavior and offset for fixed header
  const section = document.getElementById(tabId);
  if (section) {
    const offset = 120; // Height of fixed header
    const bodyRect = document.body.getBoundingClientRect().top;
    const elementRect = section.getBoundingClientRect().top;
    const elementPosition = elementRect - bodyRect;
    const offsetPosition = elementPosition - offset;

    window.scrollTo({
      top: offsetPosition,
      behavior: 'smooth'
    });
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Initialize tab click handlers
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', function() {
      const tabId = this.getAttribute('data-tab');
      switchTab(tabId);
    });
  });

  // Add scroll event listener
  window.addEventListener('scroll', updateActiveTabOnScroll, { passive: true });

  // Set initial active tab
  switchTab('info');
  
  // Initialize dropdowns after a small delay to ensure Select2 is loaded
  setTimeout(() => {
    initializeSearchableFields();
  }, 100);

  // Add tooltips to form fields
  const tooltips = {
    'fullName': 'Enter patient\'s full name',
    'mrdNumber': 'Enter medical record number',
    'age': 'Enter patient\'s age',
    'gender': 'Enter patient\'s gender (Male/Female/Other)',
    'purposeOfVisit': 'Enter reason for visit (e.g. Consultation, Review, Emergency)',
    'chiefComplaint': 'Enter main complaint',
    'durationUnit': 'Select duration unit',
    'durationValue': 'Enter duration value',
    'pastMedicalHistory': 'Enter past medical conditions',
    'currentMedications': 'Enter current medications',
    'allergies': 'Enter any known allergies',
    'familyHistory': 'Enter relevant family medical history',
    'medications': 'Enter prescribed medications',
    'additionalInvestigations': 'Enter additional tests needed',
    'patientEducation': 'Enter education/instructions given',
    'specialistReferral': 'Enter referral details if needed',
    'vaLeftUnaided': 'Enter unaided vision (e.g. 6/6, 6/9)',
    'vaLeftAided': 'Enter aided vision with correction',
    'vaRightUnaided': 'Enter unaided vision (e.g. 6/6, 6/9)',
    'vaRightAided': 'Enter aided vision with correction',
    'iopLeft': 'Enter IOP reading in mmHg',
    'iopRight': 'Enter IOP reading in mmHg',
    'procedures': 'Enter procedures performed',
    'examNotes': 'Enter examination findings and notes',
    'followUpSchedule': 'Select next appointment date'
  };

  Object.keys(tooltips).forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.setAttribute('placeholder', tooltips[id]);
      
      // Add title attribute for hover tooltip
      element.setAttribute('title', tooltips[id]);
    }
  });

  // Initialize VA dropdowns
  function initializeVADropdowns() {
    const vaDropdowns = document.querySelectorAll('.va-select');
    const toggle = document.getElementById('vaFormatToggle');
    const formatLabel = document.getElementById('vaFormatLabel');
    
    function updateDropdowns(useLogMAR) {
      vaDropdowns.forEach(dropdown => {
        const currentValue = dropdown.value;
        dropdown.innerHTML = '<option value="">Select VA</option>';
        
        // Check if this is a near vision dropdown based on ID
        const isNearVision = dropdown.id.toLowerCase().includes('near');
        
        // Use the appropriate value arrays based on distance/near
        const values = isNearVision ? 
          (useLogMAR ? VA_VALUES_LOGMAR_NEAR : VA_VALUES_SNELLEN_NEAR) :
          (useLogMAR ? VA_VALUES_LOGMAR : VA_VALUES_SNELLEN);
        
        // Add options
        values.forEach(value => {
          const option = document.createElement('option');
          option.value = value;
          option.textContent = value;
          dropdown.appendChild(option);
        });

        // Preserve selected value if possible
        if (currentValue) {
          const mappings = isNearVision ? VA_MAPPINGS_NEAR : VA_MAPPINGS;
          const mappedValue = useLogMAR ? 
            mappings[currentValue]?.logmar : 
            Object.keys(mappings).find(k => mappings[k].logmar === currentValue);
          dropdown.value = mappedValue || '';
        }
      });
      
      // Update format label
      formatLabel.textContent = useLogMAR ? 'LogMAR' : 'Snellen';
    }
    
    // Add change listener for format toggle
    toggle.addEventListener('change', (e) => {
      updateDropdowns(e.target.checked);
      updateVAInterpretation();
    });
    
    // Initialize dropdowns
    updateDropdowns(false);
  }

  initializeVADropdowns();

  // Set up arrow controls for visual acuity fields
  ['vaLeftUnaided', 'vaLeftAided', 'vaRightUnaided', 'vaRightAided', 'revisitVaLeft', 'revisitVaRight'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('keydown', handleVAKeydown);
    }
  });

  // Set up arrow controls for prescription fields
  ['sphRight', 'cylRight', 'axisRight', 'addRight', 'sphLeft', 'cylLeft', 'axisLeft', 'addLeft',
   'retinoscopySphRight', 'retinoscopyCylRight', 'retinoscopyAxisRight',
   'retinoscopySphLeft', 'retinoscopyCylLeft', 'retinoscopyAxisLeft'].forEach(id => {
    const element = document.getElementById(id);
    if (element) {
      element.addEventListener('keydown', handlePrescriptionKeydown);
    }
  });

  document.getElementById('durationUnit').addEventListener('change', function() {
    const unit = this.value;
    const valueInput = document.getElementById('durationValue');
    
    if (unit) {
      valueInput.style.display = 'block';
      valueInput.value = ''; // Reset value when unit changes
      valueInput.placeholder = `Enter number of ${unit}`;
    } else {
      valueInput.style.display = 'none'; 
    }
  });

  document.getElementById('durationValue').addEventListener('input', function() {
    const unit = document.getElementById('durationUnit').value;
    const value = this.value;
    
    if (value && unit) {
      // Update symptom duration text input
      document.getElementById('symptomDuration').value = `${value} ${unit}`;
    }
  });

  // Add event listeners for duration fields
  const historyFields = [
    'ocularHistory',
    'pastMedicalHistory', 
    'currentMedications',
    'allergies',
    'familyHistory'
  ];

  historyFields.forEach(field => {
    document.getElementById(`${field}DurationUnit`).addEventListener('change', function() {
      const valueInput = document.getElementById(`${field}DurationValue`);
      if (this.value) {
        valueInput.style.display = 'block';
        valueInput.value = '';
        valueInput.placeholder = `Enter number of ${this.value}`;
      } else {
        valueInput.style.display = 'none';
      }
    });
  });
});

function updateActiveTabOnScroll() {
  const sections = document.querySelectorAll('.tab-content');
  const tabs = document.querySelectorAll('.tab');
  
  // Get the scroll position
  const scrollPosition = window.scrollY + 120; // Add offset for fixed header
  
  // Find which section is currently in view
  sections.forEach((section) => {
    const sectionTop = section.offsetTop;
    const sectionHeight = section.clientHeight;
    
    if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
      // Remove active class from all tabs
      tabs.forEach(tab => tab.classList.remove('active'));
      
      // Add active class to current section's tab
      const currentTab = document.querySelector(`.tab[data-tab="${section.id}"]`);
      if (currentTab) {
        currentTab.classList.add('active');
      }
    }
  });
}

// Update visual acuity interpretation function
function updateVAInterpretation() {
  const isLogMAR = document.getElementById('vaFormatToggle').checked;
  
  // Distance vision values
  const vaRightUnaidedDistance = document.getElementById('vaRightUnaidedDistance').value;
  const vaLeftUnaidedDistance = document.getElementById('vaLeftUnaidedDistance').value;
  const vaRightAidedDistance = document.getElementById('vaRightAidedDistance').value;
  const vaLeftAidedDistance = document.getElementById('vaLeftAidedDistance').value;
  
  // Near vision values
  const vaRightUnaidedNear = document.getElementById('vaRightUnaidedNear').value;
  const vaLeftUnaidedNear = document.getElementById('vaLeftUnaidedNear').value;
  const vaRightAidedNear = document.getElementById('vaRightAidedNear').value;
  const vaLeftAidedNear = document.getElementById('vaLeftAidedNear').value;
  
  const interpretationDiv = document.getElementById('vaInterpretation');
  
  if (!vaRightUnaidedDistance && !vaLeftUnaidedDistance && !vaRightAidedDistance && !vaLeftAidedDistance &&
      !vaRightUnaidedNear && !vaLeftUnaidedNear && !vaRightAidedNear && !vaLeftAidedNear) {
    interpretationDiv.innerHTML = 'Select visual acuity measurements above to see interpretation.';
    interpretationDiv.classList.remove('has-value');
    return;
  }

  interpretationDiv.classList.add('has-value');
  
  let interpretation = '<h3>Visual Acuity Interpretation</h3>';
  interpretation += '<table><thead><tr><th>Eye</th><th>Distance/Near</th><th>Unaided</th><th>Aided</th><th>Description</th></tr></thead><tbody>';

  function getVADescription(value, isNear) {
    const mappings = isNear ? VA_MAPPINGS_NEAR : VA_MAPPINGS;
    const isLogMAR = document.getElementById('vaFormatToggle').checked;
    
    if (!value) return '';
    
    if (isLogMAR) {
      const snellenKey = Object.keys(mappings).find(k => mappings[k].logmar === value);
      return mappings[snellenKey]?.description || '';
    }
    return mappings[value]?.description || '';
  }

  // Right Eye Distance row
  interpretation += '<tr><td rowspan="2">Right Eye (OD)</td><td>Distance</td>';
  interpretation += `<td>${vaRightUnaidedDistance || '-'}</td>`;
  interpretation += `<td>${vaRightAidedDistance || '-'}</td>`;
  interpretation += `<td>${getVADescription(vaRightUnaidedDistance, false)}${vaRightAidedDistance ? '<br>' + getVADescription(vaRightAidedDistance, false) : ''}</td></tr>`;

  // Right Eye Near row
  interpretation += '<tr><td>Near</td>';
  interpretation += `<td>${vaRightUnaidedNear || '-'}</td>`;
  interpretation += `<td>${vaRightAidedNear || '-'}</td>`;
  interpretation += `<td>${getVADescription(vaRightUnaidedNear, true)}${vaRightAidedNear ? '<br>' + getVADescription(vaRightAidedNear, true) : ''}</td></tr>`;

  // Left Eye Distance row
  interpretation += '<tr><td rowspan="2">Left Eye (OS)</td><td>Distance</td>';
  interpretation += `<td>${vaLeftUnaidedDistance || '-'}</td>`;
  interpretation += `<td>${vaLeftAidedDistance || '-'}</td>`;
  interpretation += `<td>${getVADescription(vaLeftUnaidedDistance, false)}${vaLeftAidedDistance ? '<br>' + getVADescription(vaLeftAidedDistance, false) : ''}</td></tr>`;

  // Left Eye Near row
  interpretation += '<tr><td>Near</td>';
  interpretation += `<td>${vaLeftUnaidedNear || '-'}</td>`;
  interpretation += `<td>${vaLeftAidedNear || '-'}</td>`;
  interpretation += `<td>${getVADescription(vaLeftUnaidedNear, true)}${vaLeftAidedNear ? '<br>' + getVADescription(vaLeftAidedNear, true) : ''}</td></tr>`;

  interpretation += '</tbody></table>';

  interpretationDiv.innerHTML = interpretation;
}

function handleVAKeydown(e) {
  const isNearVision = this.id.toLowerCase().includes('near');
  const values = isNearVision ? 
    (document.getElementById('vaFormatToggle').checked ? VA_VALUES_LOGMAR_NEAR : VA_VALUES_SNELLEN_NEAR) :
    (document.getElementById('vaFormatToggle').checked ? VA_VALUES_LOGMAR : VA_VALUES_SNELLEN);

  let currentIndex = values.indexOf(this.value);
  if (currentIndex === -1) currentIndex = 0;

  if (e.key === 'ArrowUp') {
    currentIndex = currentIndex > 0 ? currentIndex - 1 : values.length - 1;
  } else {
    currentIndex = currentIndex < values.length - 1 ? currentIndex + 1 : 0;
  }

  this.value = values[currentIndex];
  updateVAInterpretation();
}

function handlePrescriptionKeydown(e) {
  if (e.key === 'ArrowUp' || e.key === 'ArrowDown') {
    e.preventDefault();
    
    const step = this.id.includes('axis') ? PRESCRIPTION_STEPS.axis :
                 this.id.includes('cyl') ? PRESCRIPTION_STEPS.cyl :
                 this.id.includes('add') ? PRESCRIPTION_STEPS.add :
                 PRESCRIPTION_STEPS.sph;
                 
    let currentValue = parseFloat(this.value) || 0;
    
    if (this.id.includes('axis')) {
      if (e.key === 'ArrowUp') {
        currentValue = currentValue >= 180 ? 1 : currentValue + step;
      } else {
        currentValue = currentValue <= 1 ? 180 : currentValue - step;
      }
    } else {
      if (e.key === 'ArrowUp') {
        currentValue += step;
      } else {
        currentValue -= step;
      }
      
      // Limit ranges for different measurements
      if (this.id.includes('sph')) {
        currentValue = Math.min(Math.max(currentValue, -25), 25);
      } else if (this.id.includes('cyl')) {
        currentValue = Math.min(Math.max(currentValue, -10), 10);
      } else if (this.id.includes('add')) {
        currentValue = Math.min(Math.max(currentValue, 0), 4);
      }
    }
    
    this.value = currentValue.toFixed(this.id.includes('axis') ? 0 : 2);
  }
}

// Export to PDF function
async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  let yPos = 20;
  
  // Add current date to header
  const currentDate = new Date().toLocaleDateString();
  
  // Header with date
  doc.setFont("helvetica", "bold");
  doc.setFontSize(16);
  doc.text("Focus EMR.AI - Patient Report", 20, yPos);
  doc.setFontSize(10);
  doc.text(currentDate, doc.internal.pageSize.width - 20, yPos, { align: 'right' });
  yPos += 15;

  // Helper function to add section headers with blue color
  function addSectionHeader(text, y) {
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.setTextColor(33, 150, 243); // Blue color
    doc.text(text, 20, y);
    
    // Add blue line under section header
    doc.setDrawColor(33, 150, 243);
    doc.setLineWidth(0.5);
    doc.line(20, y + 1, doc.internal.pageSize.width - 20, y + 1);
    
    doc.setTextColor(0); // Reset to black
    doc.setFont("helvetica", "normal");
    return y + 10;
  }

  // Patient Information Section
  yPos = addSectionHeader("Patient Information", yPos);
  doc.setFont("helvetica", "normal");
  doc.setFontSize(10);
  
  const fullName = document.getElementById('fullName').value || 'N/A';
  const mrdNumber = document.getElementById('mrdNumber').value || 'N/A';
  const age = document.getElementById('age').value || 'N/A';
  const gender = document.getElementById('gender').value || 'N/A';
  
  yPos += 5;
  doc.text(`Name: ${fullName}`, 20, yPos); yPos += 7;
  doc.text(`MRD Number: ${mrdNumber}`, 20, yPos); yPos += 7;
  doc.text(`Age: ${age}`, 20, yPos); yPos += 7;
  doc.text(`Gender: ${gender}`, 20, yPos); yPos += 15;

  // Medical History Section
  yPos = addSectionHeader("Medical History", yPos);
  yPos += 5;

  const ocularHistoryDuration = document.getElementById('ocularHistoryDurationValue').value
    ? `${document.getElementById('ocularHistoryDurationValue').value} ${document.getElementById('ocularHistoryDurationUnit').value}`
    : '';

  const pastMedicalHistoryDuration = document.getElementById('pastMedicalHistoryDurationValue').value
    ? `${document.getElementById('pastMedicalHistoryDurationValue').value} ${document.getElementById('pastMedicalHistoryDurationUnit').value}`
    : '';

  const currentMedicationsDuration = document.getElementById('currentMedicationsDurationValue').value
    ? `${document.getElementById('currentMedicationsDurationValue').value} ${document.getElementById('currentMedicationsDurationUnit').value}`
    : '';

  const allergiesDuration = document.getElementById('allergiesDurationValue').value
    ? `${document.getElementById('allergiesDurationValue').value} ${document.getElementById('allergiesDurationUnit').value}`
    : '';

  const familyHistoryDuration = document.getElementById('familyHistoryDurationValue').value
    ? `${document.getElementById('familyHistoryDurationValue').value} ${document.getElementById('familyHistoryDurationUnit').value}`
    : '';

  const ocularHistory = document.getElementById('ocularHistory').value || 'N/A';
  const pastMedicalHistory = document.getElementById('pastMedicalHistory').value || 'N/A'; 
  const currentMedications = document.getElementById('currentMedications').value || 'N/A';
  const allergies = document.getElementById('allergies').value || 'N/A';
  const familyHistory = document.getElementById('familyHistory').value || 'N/A';
  
  doc.text(`Past Ocular History: ${ocularHistory}${ocularHistoryDuration ? ` (${ocularHistoryDuration})` : ''}`, 20, yPos); yPos += 7;
  doc.text(`Past Medical History: ${pastMedicalHistory}${pastMedicalHistoryDuration ? ` (${pastMedicalHistoryDuration})` : ''}`, 20, yPos); yPos += 7;  
  doc.text(`Current Medications: ${currentMedications}${currentMedicationsDuration ? ` (${currentMedicationsDuration})` : ''}`, 20, yPos); yPos += 7;
  doc.text(`Allergies: ${allergies}${allergiesDuration ? ` (${allergiesDuration})` : ''}`, 20, yPos); yPos += 7;
  doc.text(`Family History: ${familyHistory}${familyHistoryDuration ? ` (${familyHistoryDuration})` : ''}`, 20, yPos); yPos += 15;

  // Signs & Symptoms Section
  yPos = addSectionHeader("Signs & Symptoms", yPos);
  yPos += 5;

  const chiefComplaint = document.getElementById('chiefComplaint').value || 'N/A';
  const duration = document.getElementById('durationValue').value || 'N/A';
  const unit = document.getElementById('durationUnit').value || 'N/A';
  
  doc.text(`Chief Complaint: ${chiefComplaint}`, 20, yPos); yPos += 7;
  doc.text(`Duration: ${duration} ${unit}`, 20, yPos); yPos += 15;

  // Examination Section
  yPos = addSectionHeader("Examination", yPos);
  yPos += 5;
  
  // Create table for Refraction Results
  if (document.getElementById('procedures').value === 'refraction') {  
    // Add Refraction Results table
    doc.setFontSize(10);
    doc.setTextColor(0);
    
    // Table headers
    const headers = ['Eye', 'SPH', 'CYL', 'AXIS'];
    const colWidths = [30, 30, 30, 30];
    const startX = 20;
    let currentY = yPos;
    
    // Draw table header
    doc.setFillColor(233, 236, 239); // Light gray background
    doc.rect(startX, currentY, 120, 7, 'F');
    doc.setTextColor(33, 150, 243); // Blue color for headers
    doc.setFont("helvetica", "bold");
    
    headers.forEach((header, i) => {
      doc.text(header, startX + (i * colWidths[0]), currentY + 5);
    });
    
    currentY += 7;
    doc.setTextColor(0);
    doc.setFont("helvetica", "normal");

    // Right Eye data
    const rightEyeData = [
      'OD',
      formatPlusSign(document.getElementById('retinoscopySphRight').value) || 'N/A',
      formatPlusSign(document.getElementById('retinoscopyCylRight').value) || 'N/A',
      document.getElementById('retinoscopyAxisRight').value || 'N/A'
    ];
    
    // Left Eye data
    const leftEyeData = [
      'OS', 
      formatPlusSign(document.getElementById('retinoscopySphLeft').value) || 'N/A',
      formatPlusSign(document.getElementById('retinoscopyCylLeft').value) || 'N/A',
      document.getElementById('retinoscopyAxisLeft').value || 'N/A'
    ];

    // Draw data rows
    [rightEyeData, leftEyeData].forEach((rowData, rowIndex) => {
      // Alternate row background
      if (rowIndex % 2 === 0) {
        doc.setFillColor(249, 249, 249);
        doc.rect(startX, currentY, 120, 7, 'F');
      }
      
      rowData.forEach((cell, cellIndex) => {
        doc.text(String(cell), startX + (cellIndex * colWidths[0]), currentY + 5);
      });
      currentY += 7;
    });

    yPos = currentY + 10;

    // Add prescription table with similar format
    yPos = addSectionHeader("Final Prescription", yPos);
    yPos += 5;
    
    // Reset for prescription table
    currentY = yPos;
    
    // Prescription table header
    doc.setFillColor(233, 236, 239);
    doc.rect(startX, currentY, 120, 7, 'F');
    doc.setTextColor(33, 150, 243);
    doc.setFont("helvetica", "bold");
    
    const rxHeaders = ['Eye', 'SPH', 'CYL', 'AXIS', 'ADD'];
    rxHeaders.forEach((header, i) => {
      doc.text(header, startX + (i * 25), currentY + 5);
    });
    
    currentY += 7;
    doc.setTextColor(0);
    doc.setFont("helvetica", "normal");

    // Prescription data rows
    const rxRightEye = [
      'OD',
      formatPlusSign(document.getElementById('sphRight').value) || 'N/A',
      formatPlusSign(document.getElementById('cylRight').value) || 'N/A',
      document.getElementById('axisRight').value || 'N/A',
      formatPlusSign(document.getElementById('addRight').value) || 'N/A'
    ];
    
    const rxLeftEye = [
      'OS',
      formatPlusSign(document.getElementById('sphLeft').value) || 'N/A',
      formatPlusSign(document.getElementById('cylLeft').value) || 'N/A',
      document.getElementById('axisLeft').value || 'N/A',
      formatPlusSign(document.getElementById('addLeft').value) || 'N/A'
    ];

    [rxRightEye, rxLeftEye].forEach((rowData, rowIndex) => {
      if (rowIndex % 2 === 0) {
        doc.setFillColor(249, 249, 249);
        doc.rect(startX, currentY, 125, 7, 'F');
      }
      
      rowData.forEach((cell, cellIndex) => {
        doc.text(String(cell), startX + (cellIndex * 25), currentY + 5);
      });
      currentY += 7;
    });

    yPos = currentY + 10;
  }

  // Visual Acuity section
  yPos = addSectionHeader("Visual Acuity", yPos);
  yPos += 5;

  // Create VA table
  const vaStartX = 20;
  const colWidths = [30, 50, 50, 50];
  let currentY = yPos;

  // Table headers 
  doc.setFillColor(233, 236, 239);
  doc.rect(vaStartX, currentY, 180, 7, 'F');
  doc.setTextColor(33, 150, 243);
  doc.setFont("helvetica", "bold");

  const vaHeaders = ['Eye', 'Distance/Near', 'Unaided', 'Aided'];
  vaHeaders.forEach((header, i) => {
    doc.text(header, vaStartX + (i * colWidths[1]), currentY + 5);
  });

  currentY += 7;
  doc.setTextColor(0);
  doc.setFont("helvetica", "normal");

  // Right Eye Distance row
  const rightDistanceData = [
    'OD',
    'Distance',
    document.getElementById('vaRightUnaidedDistance').value || 'N/A',
    document.getElementById('vaRightAidedDistance').value || 'N/A'
  ];

  // Right Eye Near row  
  const rightNearData = [
    'OD',
    'Near', 
    document.getElementById('vaRightUnaidedNear').value || 'N/A',
    document.getElementById('vaRightAidedNear').value || 'N/A'
  ];

  // Left Eye Distance row
  const leftDistanceData = [
    'OS',
    'Distance', 
    document.getElementById('vaLeftUnaidedDistance').value || 'N/A',
    document.getElementById('vaLeftAidedDistance').value || 'N/A'
  ];

  // Left Eye Near row
  const leftNearData = [
    'OS',
    'Near',
    document.getElementById('vaLeftUnaidedNear').value || 'N/A',
    document.getElementById('vaLeftAidedNear').value || 'N/A'  
  ];

  // Draw data rows
  [rightDistanceData, rightNearData, leftDistanceData, leftNearData].forEach((rowData, rowIndex) => {
    if (rowIndex % 2 === 0) {
      doc.setFillColor(249, 249, 249);
      doc.rect(vaStartX, currentY, 180, 7, 'F');
    }
    
    rowData.forEach((cell, cellIndex) => {
      doc.text(String(cell), vaStartX + (cellIndex * colWidths[1]), currentY + 5);
    });
    currentY += 7;
  });

  yPos = currentY + 10;

  // Treatment Plan Section
  yPos = addSectionHeader("Treatment Plan", yPos);
  yPos += 5;
  
  const medications = document.getElementById('medications').value || 'N/A';
  const investigations = document.getElementById('additionalInvestigations').value || 'N/A';
  const followUp = document.getElementById('followUpSchedule').value || 'N/A';
  const education = document.getElementById('patientEducation').value || 'N/A';
  
  doc.text(`Medications: ${medications}`, 20, yPos); yPos += 7;
  doc.text(`Additional Investigations: ${investigations}`, 20, yPos); yPos += 7;
  doc.text(`Follow-up Schedule: ${followUp}`, 20, yPos); yPos += 7;
  doc.text(`Patient Education: ${education}`, 20, yPos);

  // Save PDF
  const fileName = `Focus_EMR_AI_Report_${document.getElementById('fullName').value || 'Patient'}_${new Date().toISOString().split('T')[0]}.pdf`;
  doc.save(fileName);
}

// Helper function to format plus signs if not exists
function formatPlusSign(value) {
  if (!value) return '';
  const num = parseFloat(value);
  return num > 0 ? `+${num}` : String(num);
}
</script>
</body>
</html>